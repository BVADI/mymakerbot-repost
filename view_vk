{key_clear}
{if !isset($black_list)}{$black_list=[]}{/if}  {*–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤*}
{if !isset($white_list)}{$white_list=[]}{/if}  {*–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤*}
{if !isset($repost_black_id)}{$repost_black_id=[]}{/if} {*–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø (id) –Ω–∞ —Ä–µ–ø–æ—Å—Ç*}
{if !isset($registered)}{$registered=1}{/if} {*–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è =0, –Ω–µ –∑–∞–Ω–æ—Å–∏—Ç—Å—è –≤ –±–∞–∑—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π —Ä–µ–ø–æ—Å—Ç*}
{if !isset($src_link)}{$src_link=1}{/if} {*–°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫*}
{if !isset($sign_link)}{$sign_link='‚û∞ –í–ö'}{/if} {*–ü–æ–¥–ø–∏—Å—å –∫ —Å—Å—ã–ª–∫–µ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ –í–ö*}
{if !isset($sign)}{$sign=''}{/if}  {*–ü–æ–¥–ø–∏—Å—å —Å–Ω–∏–∑—É*}
{if !isset($sign_up)}{$sign_up=''}{/if} {*–ü–æ–¥–ø–∏—Å—å —Å–≤–µ—Ä—Ö—É*}
{if !isset($media_post)}{$media_post=1}{/if} {*–ü—É–±–ª–∏–∫–∞—Ü–∏—è –º–µ–¥–∏–∞-–ø–æ—Å—Ç–∞*}
{if !isset($ads)}{$ads=0}{/if} {*–†–µ–∫–ª–∞–º–∞*}
{if !isset($group)}{$group='vk'}{/if}
{if !isset($show_message)}{$show_message=1}{/if} {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è*}
{if !isset($show_photo)}{$show_photo=1}{/if}  {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏*}
{if !isset($show_links)}{$show_links=1}{/if}    {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Å—ã–ª–∫–∏*}
{if !isset($show_links_details)}{$show_links_details=0}{/if}   {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —Å—Å—ã–ª–∫–∏*}
{if !isset($show_links_title)}{$show_links_title=1}{/if}   {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Å—ã–ª–∫–∏*}
{if !isset($show_links_description)}{$show_links_description=0}{/if}   {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏*}
{if !isset($show_videos)}{$show_videos=1}{/if}  {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–∏–¥–µ–æ*}
{if !isset($show_video_details)}{$show_video_details=0}{/if}  {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –≤–∏–¥–µ–æ*}
{if !isset($show_video_title)}{$show_video_title=1}{/if}  {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–∏–¥–µ–æ*}
{if !isset($show_video_description)}{$show_video_description=0}{/if}  {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ*}
{if !isset($show_docs)}{$show_docs=1}{/if}  {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã*}
{if !isset($show_audio)}{$show_audio=0}{/if}   {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞—É–¥–∏–æ (–Ω—É–∂–µ–Ω —Ç–æ–∫–µ–Ω –∏ –ø–æ–¥–ø–∏—Å–∫–∞)*}
{if !isset($show_poll)}{$show_poll=1}{/if}   {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–ø—Ä–æ—Å—ã*}
{if !isset($show_creator)}{$show_creator=1}{/if}   {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–≤—Ç–æ—Ä–∞*}
{if !isset($show_creator_url)}{$show_creator_url=1}{/if}  {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –∞–≤—Ç–æ—Ä–∞*}
{if !isset($show_repost)}{$show_repost=1}{/if}  {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–ø–æ—Å—Ç—ã*}
{if !isset($show_repost_comment)}{$show_repost_comment=1}{/if}   {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Ä–µ–ø–æ—Å—Ç–æ–≤*}
{if !isset($show_repost_date)}{$show_repost_date=1}{/if}  {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–∞—Ç—É —Ä–µ–ø–æ—Å—Ç–∞*}
{if !isset($show_repost_url)}{$show_repost_url=1}{/if}   {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Ä–µ–ø–æ—Å—Ç*}
{if !isset($show_repost_source)}{$show_repost_source=1}{/if}   {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ —Ä–µ–ø–æ—Å—Ç–∞*}
{if !isset($show_post_user)}{$show_post_user=1}{/if}   {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π*}
{if !isset($show_community)}{$show_community=1}{/if}  {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ—Å—Ç—ã —Å–æ–æ–±—â–µ—Å—Ç–≤–∞*}
{if !isset($show_hashtag)}{$show_hashtag=1}{/if}  {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ö—ç—à—Ç–µ–≥–∏*}
{if !isset($show_photoalbum)}{$show_photoalbum=1}{/if}  {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–ª—å–±–æ–º—ã*}
{if !isset($show_photoalbum_description)}{$show_photoalbum_description=0}{/if}  {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∞–ª—å–±–æ–º–æ–≤*}
{*if !isset($disable_notification)}{$disable_notification=0}{/if*}{*–í—ã–∫–ª—é—á–∏—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ*}
{if !isset($disable_notification) && !isset($show_notification)}{$disable_notification=0}
{elseif !isset($disable_notification) && isset($show_notification)}{$disable_notification=!$show_notification}
{elseif isset($disable_notification) && !isset($show_notification)}{$disable_notification=$disable_notification}
{else}{$disable_notification=!$show_notification}{/if}{*–í—ã–∫–ª—é—á–∏—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ*}
{if !isset($disable_notif_start)}{$disable_notif_start=''}{/if}  {*–í—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞ –≤—ã–∫–ª—é—á–µ–Ω–∏—è –æ–ø–æ–≤–µ—â–µ–Ω–∏—è*}
{if !isset($disable_notif_stop)}{$disable_notif_stop=''}{/if} {*–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∏—è –æ–ø–æ–≤–µ—â–µ–Ω–∏—è*}
{*if !isset($disable_web_page_preview)}{$disable_web_page_preview=1}{/if*}
{if !isset($disable_web_page_preview) && !isset($show_web_page_preview)}{$disable_web_page_preview=0}
{elseif !isset($disable_web_page_preview) && isset($show_web_page_preview)}{$disable_web_page_preview=!$show_web_page_preview}
{elseif isset($disable_web_page_preview) && !isset($show_web_page_preview)}{$disable_web_page_preview=$disable_web_page_preview}
{else}{$disable_web_page_preview=!$show_web_page_preview}{/if}{*–í—ã–∫–ª—é—á–∏—Ç—å –ø—Ä–µ–≤—å—é*}
{if !isset($token)}{$token=''}{/if}
{if !isset($keys_src)}{$keys_src=0}{/if} {*–ö–Ω–æ–ø–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ –í–ö*}
{if !isset($keys_links)}{$keys_links=0}{/if} {*–ö–Ω–æ–ø–∫–∏ –Ω–∞ —Å—Å—ã–ª–∫–∏ –≤ —Ç–µ–∫—Å—Ç–µ*}
{if !isset($keys_docs)}{$keys_docs=0}{/if} {*–ö–Ω–æ–ø–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ —Ç–µ–∫—Å—Ç–µ*}
{if !isset($keys_videos)}{$keys_videos=0}{/if} {*–ö–Ω–æ–ø–∫–∏ –Ω–∞ –≤–∏–¥–µ–æ –≤ —Ç–µ–∫—Å—Ç–µ*}
{if !isset($keys_albums)}{$keys_albums=0}{/if} {*–ö–Ω–æ–ø–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ-–∞–ª—å–±–æ–º—ã –≤ —Ç–µ–∫—Å—Ç–µ*}
{if !isset($show_one_photo)}{$show_one_photo=0}{/if} {*–û–¥–Ω–æ —Ñ–æ—Ç–æ –≤–º–µ—Å—Ç–æ –º–µ–¥–∏–∞–ø–æ—Å—Ç–∞*}
{if !isset($show_gif)}{$show_gif=1}{/if} {*–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å gif –∞–Ω–∏–º–∞—Ü–∏—é*}
{if !isset($show_docs_photo)}{$show_docs_photo=0}{/if} {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ-—Ñ–∞–π–ª—ã*}
{if !isset($show_photo_web_preview)}{$show_photo_web_preview=0}{/if} {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ –≤ –ø—Ä–µ–≤—å—é*}
{if !isset($show_video_web_preview)}{$show_video_web_preview=1}{/if} {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–µ—Ä–≤–æ–µ –≤–∏–¥–µ–æ –≤ –ø—Ä–µ–≤—å—é*}
{if !isset($photo_height)}{$photo_height=1500}{/if} {*–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏, *}
{if !isset($show_photo_from_video)}{$show_photo_from_video=1}{/if} {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–∑ –≤–∏–¥–µ–æ, 0 - –Ω–µ—Ç, 1 - –¥–∞, –µ—Å–ª–∏ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –∫–∞—Ä—Ç–∏–Ω–æ–∫, 2 - –≤—Å–µ–≥–¥–∞*}
{if !isset($show_photo_from_link)}{$show_photo_from_link=0}{/if} {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–∑ —Å—Å—ã–ª–æ–∫, 0 - –Ω–µ—Ç, 1 - –¥–∞, –µ—Å–ª–∏ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –∫–∞—Ä—Ç–∏–Ω–æ–∫, 2 - –≤—Å–µ–≥–¥–∞*}
{if !isset($send_message_standart)}{$send_message_standart=0}{/if} {*0 - –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –ø–æ—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ –Ω–∞ –∑–∞–¥–∞–Ω–Ω–æ–µ –∫–æ–ª-–≤–æ —Å–∏–º–≤–æ–ª–æ–≤, 1 - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–≥–æ, —Ä–µ–∂–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏*}
{if !isset($send_message_len)}{$send_message_len=3500}{/if} {*–î–ª–∏–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º–æ–≥–æ —Ç–µ–∫—Å—Ç–∞*}
{if !isset($show_media_keys)}{$show_media_keys=0}{/if} {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –¥–ª—è –º–µ–¥–∏–∞ –ø–æ—Å—Ç–∞*}
{if !isset($show_log_error)}{$show_log_error=0}{/if} {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–æ–≥ –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏*}
{if !isset($show_log_send)}{$show_log_send=0}{/if} {*–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–æ–≥ –ø—É–±–ª–∏–∫–∞—Ü–∏–π*}

{if $v.message|check_black_list:$black_list && $v.message|check_white_list:$white_list 
    && (!$registered || !$v.guid|group_vk:$group:1) 
    && (!$v.marked_as_ads || ($v.marked_as_ads && $ads))
    && (($show_repost && (isset($v.original.copy_history.0.id))) || !isset($v.original.copy_history.0.id) )
    && (($show_post_user &&  ($v.original.from_id != $v.original.owner_id)) || !($v.original.from_id != $v.original.owner_id ))
    && (($show_community && ($v.original.from_id == $v.original.owner_id) && !isset($v.original.copy_history.0.id)) 
    	|| !(!isset($v.original.copy_history.0.id) && ($v.original.from_id == $v.original.owner_id)))
    }     

{*import c='/log' msg=$v|json*}

{$v.message = str_replace('<', '', $v.message)}
{$v.message = str_replace('>', '', $v.message)}

{* –í—ã–∫–ª—é—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π *}
{if !empty($disable_notif_stop) && !empty($disable_notif_start)}
	{$date = $v.original.date}
	{$tstart = strtotime("today + {$disable_notif_start} hours")}
	{$tstop = strtotime("today + {$disable_notif_start} hours")}
	{if $tstart < $tstop}
		{if $date > $tstart && $date < $tstop}
   		 	{$disable_notification = 1}
		{/if}
 	{else} 
		{if $date > $tstart || $date < $tstop}
    		{$disable_notification = 1}
    	{/if}
	{/if} 
{/if}

{* HashTag *}
{if !$show_hashtag}
{*$v.message = $v.message|regex_replace:"/#.*/":""*}
{$v.message = $v.message|regex_replace:'/#(\S+)/':''}
{/if}

{* Repost comment *}
{if !empty($v.original.copy_history.0.id) && ($show_repost_comment || $show_repost_source )}
{if mb_substr($v.original.copy_history.0.owner_id,0,1) == "-"}
{$url="https://api.vk.com/method/groups.getById?group_id={str_replace("-","",$v.original.copy_history.0.owner_id)}&access_token={$service_key}&lang=ru&v=5.103"}
{api url=$url method='GET' format='json' assign='gr'}

{$repost_url = ""}
  {if $show_repost_url}
    {$repost_url = "https://vk.com/public{$gr.response.0.id}"}
  {/if}
{$repost_url = "<a href='$repost_url'>{$gr.response.0.name}</a>"}
{$responseid = $gr.response.0.id}
{else}
{$url="https://api.vk.com/method/users.get?user_ids={$v.original.copy_history.0.owner_id}&fields=sex&access_token={$service_key}&lang=ru&v=5.103"}
{api url=$url method='GET' format='json' assign='user'}
{$repost_url = ""}
{if $show_repost_url}
  {$repost_url = "https://vk.com/id{$user.response.0.id}"}
{/if}
{$repost_url = "<a href='$repost_url'>{$user.response.0.last_name} {$user.response.0.first_name}</a>"}
{$responseid = $user.response.0.id}
{/if}
{if $show_repost_date}
  {$v.message = "(<code>{date('d.m.Y H:i', $v.original.copy_history.0.date)}</code>)

`$v.message`"}
{/if}
{if $show_repost_source}
{$v.message = "‚Ü™ $repost_url
`$v.message`"}
{/if}
{if $show_repost_comment}
{if (isset($v.original.text) && !empty($v.original.text) )}
   {$repost_comment="{$v.original.text|vk_link:true}

--------------------------------------------------------------"}
{$v.message = "$repost_comment
`$v.message`"}
{/if}
{/if}
{/if}

{$v.message=$v.message|vk_link:true}
{$v.message=$v.message|vk_link:true}

{* attach *} 
   {if !empty($v.original.attachments) }
    	{$attach = $v.original.attachments}
   {/if}    
   {if !empty($v.original.copy_history.0.attachments)}
    	{$attachcopy = $v.original.copy_history.0.attachments}
   {/if}
   
{* Photo *}
{if $show_photo || $media_post || $show_one_photo || $show_photo_web_preview || $show_videos}
  {$v.photo=[]}
	{if !empty($attach)}
  		 {foreach from=$attach item=p1}
           {* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ *}
         	{if $p1.type == 'photo'}
   				{$height = 0 }
   				{$photo2 = ''}
               		{foreach from=$p1['photo']['sizes'] item=p2}
                        {if $p2.height >= $height && $p2.height < $photo_height} 
 							{$photo2 = $p2['url']}
      						{$height = $p2['height']}
                        {/if}
                    {/foreach}
                {$v.photo[] = ['type' => 'photo', 'media' => $photo2, 'caption'=>'']}
			{/if}
            {* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤*}
            {if ($p1.type == 'doc') && ($p1.doc.ext == 'jpg')}
   					{$height = 0 }
   					{$photo2 = ''}
        	       		{foreach from=$p1['doc']['preview']['photo']['sizes'] item=p2}
          	              {if $p2.height >= $height && $p2.height < $photo_height}
 								{$photo2 = $p2['src']}
      							{$height = $p2['height']}
            	            {/if}
           		        {/foreach}
                    {$v.photo[] = ['type' => 'photo', 'media' => $photo2, 'caption'=>'']}
			{/if}
            {* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –∏–∑ –∞–ª—å–±–æ–º–æ–≤*}
            {if $p1.type == 'album'}
   				{$height = 0}
   				{$photo2 = ''}
               		{foreach from=$p1['album']['thumb']['sizes'] item=p2}
                        {if $p2.height >= $height && $p2.height < $photo_height}
 							{$photo2 = $p2['url']}
      						{$height = $p2['height']}
                        {/if}
                    {/foreach}
                {$v.photo[] = ['type' => 'photo', 'media' => $photo2, 'caption'=>'']}
			{/if}
            {* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –∏–∑ —Å—Å—ã–ª–æ–∫*}
            {if $show_photo_from_link == 1 && count($v.photo) == 0}
              {$show_photo_f_link = 1}
            {elseif $show_photo_from_link == 2}
              {$show_photo_f_link = 1}
            {else}
              {$show_photo_f_link = 0}
            {/if}  
            {if $show_photo_f_link}
             {if $p1.type == 'link' && !empty($p1.link.photo) && ($p1.link.description != 'Playlist')}
   				{$height = 0}
   				{$photo2 = ''}
               		{foreach from=$p1['link']['photo']['sizes'] item=p2}
                        {if $p2.height > $height && $p2.height < $photo_height}
 							{$photo2 = $p2['url']}
      						{$height = $p2['height']}
                        {/if}
                    {/foreach}
                {$v.photo[] = ['type' => 'photo', 'media' => $photo2, 'caption'=>'']}
			{/if}
           {/if}
		{/foreach}
        {* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Å—ã–ª–æ–∫ –∏–∑ –≤–∏–¥–µ–æ*}
        {if count($v.video)>0 && $show_videos && !empty($token)}
       
        {$vi=0}
 		 {foreach from=$attach item=p1}
   			{if $p1.type == 'video' && !empty($token)}
            	{if !empty($p1.video.access_key)}
                    {$videos="{$p1.video.owner_id}_{$p1.video.id}_{$p1.video.access_key}"}
                {else}
                    {$videos="{$p1.video.owner_id}_{$p1.video.id}"}
                {/if}
                {$url="https://api.vk.com/method/video.get?&access_token=$token&owner_id={$p1.video.owner_id}&videos=$videos&v=5.126"}
                {api url=$url method='GET' format='json' assign='vid'}
                {if !empty($vid.response.items.0.player)}
                  {$v.video.$vi.url = $vid.response.items.0.player}
                  {if !empty($vid.response.items.0.platform)}{$v.video.$vi.platform = $vid.response.items.0.platform}{/if}
                  {if ($show_photo_from_video != 2) && !empty($v.video.$vi.platform)}{$show_photo_from_video = 0}{/if}
                {else}
                  {if !empty($p1.video.access_key) && mb_substr($p1.video.access_key,0,3)=='ln-'}
                    {$v.video.$vi.url ="https://vk.com/video`$p1.video.owner_id`_`$p1.video.id`?list=`$p1.video.access_key`"}
                  {else}
                    {$v.video.$vi.url ="https://vk.com/video`$p1.video.owner_id`_`$p1.video.id`"}
                  {/if}
   			    {/if}
                {$vi=$vi+1}
   			{/if}
  		 {/foreach}
        {/if} 
       {* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –∏–∑ –≤–∏–¥–µ–æ *}
            {if $show_photo_from_video == 1 && count($v.photo) == 0}
              {$show_photo_f_video = 1}
            {elseif $show_photo_from_video == 2}
              {$show_photo_f_video = 1}
            {else}
              {$show_photo_f_video = 0}
            {/if} 

          {$vi=0}
 		   {foreach from=$attach item=p1}
   			{if $p1.type == 'video'}
              {if $show_photo_f_video}
            	{if !empty($p1.video.photo_1280)}
                	{$v.photo[] = ['type' => 'photo', 'media' => $p1.video.photo_1280, 'caption'=>'']}
                 {elseif !empty($p1.video.photo_800)} 
                 	{$v.photo[] = ['type' => 'photo', 'media' => $p1.video.photo_800, 'caption'=>'']}
                 {elseif !empty($p1.video.photo_640)} 
                 	{$v.photo[] = ['type' => 'photo', 'media' => $p1.video.photo_640, 'caption'=>'']}
                {/if} 
 		      {/if}  
               {if empty($token)}
                {if !empty($p1.video.access_key) && mb_substr($p1.video.access_key,0,3)=='ln-'}
                    {$v.video.$vi.url ="https://vk.com/video`$p1.video.owner_id`_`$p1.video.id`?list=`$p1.video.access_key`"}
                {else}
                    {$v.video.$vi.url ="https://vk.com/video`$p1.video.owner_id`_`$p1.video.id`"}
                {/if}
                {$vi=$vi+1}
               {/if}
   			{/if}
  		   {/foreach}

         
		{*/if*}
	{/if}
	{if !empty($attachcopy)}
  		 {foreach from=$attachcopy item=p1}
            {* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ *}
         	{if $p1.type == 'photo'}
   				{$height = 0 }
   				{$photo2 = ''}
               		{foreach from=$p1['photo']['sizes'] item=p2}
                        {if $p2.height >= $height && $p2.height < $photo_height}
 							{$photo2 = $p2['url']}
      						{$height = $p2['height']}

                        {/if}
                    {/foreach}
                {$v.photo[] = ['type' => 'photo', 'media' => $photo2, 'caption'=>'']}
			{/if}
            {* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤*}
            {if ($p1.type == 'doc') && ($p1.doc.ext == 'jpg')}
   					{$height = 0 }
   					{$photo2 = ''}
        	       		{foreach from=$p1['doc']['preview']['photo']['sizes'] item=p2}
          	              {if $p2.height >= $height && $p2.height < $photo_height}
 								{$photo2 = $p2['src']}
      							{$height = $p2['height']}
            	            {/if}
           		        {/foreach}
                    {$v.photo[] = ['type' => 'photo', 'media' => $photo2, 'caption'=>'']}
			{/if}
            {* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –∏–∑ –∞–ª—å–±–æ–º–æ–≤*}
            {if $p1.type == 'album'}
   				{$height = 0}
   				{$photo2 = ''}
               		{foreach from=$p1['album']['thumb']['sizes'] item=p2}
                        {if $p2.height >= $height && $p2.height < $photo_height}
 							{$photo2 = $p2['url']}
      						{$height = $p2['height']}
                        {/if}
                    {/foreach}
                {$v.photo[] = ['type' => 'photo', 'media' => $photo2, 'caption'=>'']}
			{/if}
            {* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –∏–∑ —Å—Å—ã–ª–æ–∫*}
            {if $show_photo_from_link == 1 && count($v.photo) == 0}
              {$show_photo_f_link = 1}
            {elseif $show_photo_from_link == 2}
              {$show_photo_f_link = 1}
            {else}
              {$show_photo_f_link = 0}
            {/if}  
            {if $show_photo_f_link}
            {if $p1.type == 'link' && !empty($p1.link.photo) && ($p1.link.description != 'Playlist')}
   				{$height = 0}
   				{$photo2 = ''}
               		{foreach from=$p1['link']['photo']['sizes'] item=p2}
                        {if $p2.height > $height && $p2.height < $photo_height}
 							{$photo2 = $p2['url']}
      						{$height = $p2['height']}
                        {/if}
                    {/foreach}
                {$v.photo[] = ['type' => 'photo', 'media' => $photo2, 'caption'=>'']}
			{/if}  
            {/if}
		{/foreach}
        {* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Å—ã–ª–æ–∫ –∏–∑ –≤–∏–¥–µ–æ *}
        {if count($v.video)>0 && $show_videos && $token}
        {$vi=0}
 		 {foreach from=$attachcopy item=p1}
   			{if $p1.type == 'video' && !empty($token)}
                {if !empty($p1.video.access_key)}
                    {$videos="{$p1.video.owner_id}_{$p1.video.id}_{$p1.video.access_key}"}
                {else}
                    {$videos="{$p1.video.owner_id}_{$p1.video.id}"}
                {/if}
                {$url="https://api.vk.com/method/video.get?&access_token=$token&owner_id={$p1.video.owner_id}&videos=$videos&v=5.126"}
                {api url=$url method='GET' format='json' assign='vid'}
                {if !empty($vid.response.items.0.player)}
                  {$v.video.$vi.url = $vid.response.items.0.player}
                  {if !empty($vid.response.items.0.platform)}{$v.video.$vi.platform = $vid.response.items.0.platform}{/if}
                  {if ($show_photo_from_video != 2) && !empty($v.video.$vi.platform)}{$show_photo_from_video = 0}{/if}
                {else}
                  {if !empty($p1.video.access_key) && mb_substr($p1.video.access_key,0,3)=='ln-'}
                    {$v.video.$vi.url ="https://vk.com/video`$p1.video.owner_id`_`$p1.video.id`?list=`$p1.video.access_key`"}
                  {else}
                    {$v.video.$vi.url ="https://vk.com/video`$p1.video.owner_id`_`$p1.video.id`"}
                  {/if}
   			    {/if}
                {$vi=$vi+1}
             {/if}
  		 {/foreach}
        {/if} 
        {* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –∏–∑ –≤–∏–¥–µ–æ*}
            {if $show_photo_from_video == 1 && count($v.photo) == 0}
              {$show_photo_f_video = 1}
            {elseif $show_photo_from_video == 2}
              {$show_photo_f_video = 1}
            {else}
              {$show_photo_f_video = 0}
            {/if} 

          {$vi=0}
 		   {foreach from=$attachcopy item=p1}
   			{if $p1.type == 'video'}
              {if $show_photo_f_video}
            	{if !empty($p1.video.photo_1280)}
                	{$v.photo[] = ['type' => 'photo', 'media' => $p1.video.photo_1280, 'caption'=>'']}
                 {elseif !empty($p1.video.photo_800)} 
                 	{$v.photo[] = ['type' => 'photo', 'media' => $p1.video.photo_800, 'caption'=>'']}
                 {elseif !empty($p1.video.photo_640)} 
                 	{$v.photo[] = ['type' => 'photo', 'media' => $p1.video.photo_640, 'caption'=>'']}
                {/if}
		      {/if}  
               {if empty($token)}
                {if !empty($p1.video.access_key) && mb_substr($p1.video.access_key,0,3)=='ln-'}
                    {$v.video.$vi.url ="https://vk.com/video`$p1.video.owner_id`_`$p1.video.id`?list=`$p1.video.access_key`"}
                {else}
                    {$v.video.$vi.url ="https://vk.com/video`$p1.video.owner_id`_`$p1.video.id`"}
                {/if}
                {$vi=$vi+1}
               {/if}
   			{/if}
  		   {/foreach}
	{/if}
    
    {* –ü–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ –≤ –ø—Ä–µ–≤—å—é *}
    {if $show_photo_web_preview}
      {$v.message = "<a href='{$v.photo.0.media}'>‚†Ä</a>{$v.message}"}
      {$disable_web_page_preview=0}
      {$show_photo=0}
      {$media_post=0}
    {/if}
{/if}

{* LINKS *}
{if count($v.link)>0 && ($show_links || $keys_links)}
  {foreach from=$v.link key=k item=v2}
    {$url=$v2['url']}
    {$msg=$v2['url']}
    {$desc=""}
    {if (isset($v2['title']) && !empty($v2['title']) && $show_links_title)}{$msg=$v2['title']}{/if}
      {if $show_links}
        {$v.message = "`$v.message` 
    
üîó <a href='{$url}'>{$msg}</a>"}
    {if (isset($v2['description']) && !empty($v2['description']) && $show_links_description)}{$desc=$v2['description']}
    {$v.message = "`$v.message` 
`$desc`"}    
    {/if}
      {/if}
    {if $keys_links}
	 {key l=100+$k t="üîó `$msg`" c=$url}
    {/if} 
  {/foreach}
{/if}


{* VIDEOS *}
{if count($v.video)>0 && ($show_videos || $keys_videos || $show_video_web_preview)}
{if !empty($token) && $show_video_web_preview && !empty($v.video.0.platform)}
  {$url2=$v.video.0.url}
  {$v.message = "<a href='{$url2}'>‚†Ä</a>{$v.message}"}
  {$disable_web_page_preview=0}
{/if}
{foreach from=$v.video key=k item=v2}
{$url=$v2['url']}
{$msg="video"}
{$desc=""}
{if (isset($v2['title']) && !empty($v2['title']) && $show_video_title)}{$msg=$v2['title']}{/if}
  {if $show_videos}
    {$v.message = "`$v.message` 

üé• <a href='{$url}'>{$msg}</a>"}
{if (isset($v2['description']) && !empty($v2['description']) && $show_video_description)}{$desc=$v2['description']}
    {$v.message = "`$v.message` 
  $desc"}
{/if}
{if (isset($v2['views']) && !empty($v2['views']) && $show_video_details)}
    {$v.message = "`$v.message` 
  üëÅ <i>{$v2['views']} —Ä–∞–∑</i>"}
{/if}
{if (isset($v2['duration']) && !empty($v2['duration']) && $show_video_details)}
    {$v.message = "`$v.message` 
  ‚è≥ <i>{$v2['duration']} —Å–µ–∫.</i>"}
{/if}
{/if}
    {if $keys_videos}
	 {key l=110+$k t="üé• `$msg`" c=$url}
    {/if} 

{/foreach}
{/if}

{* DOC *}
{if count($v.doc)>0 && ($show_docs || $keys_docs || $show_gif || $show_docs_photo)}
  {foreach from=$v.doc key=k item=v2}
    {$url=$v2['url']}
    {$msg=$v2['url']}  
    {if $v2['ext'] == 'gif'}
       {if $show_gif}
         {tg_sendVideofile chat_id=$chat_id video="{$v2['url']}&mp4=1" caption=''  disable_notification=$disable_notification assign=res_gif}
         {if $show_log_error}{if empty($res_gif.0.result.message_id)} {import c='/log' msg="Gif –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: \n {$res_gif|json}"} {/if}{/if}
       {/if}
   {else}     
      {if $v2['ext'] == 'jpg'}
  		{if $show_docs_photo}
		{if (isset($v2['title']) && !empty($v2['title']) )}{$msg=$v2['title']}{/if}
      	{$v.message = "`$v.message` 
    
üì∑ <a href='{$url}'>{$msg}</a>"} 
		{/if}
   	  {else}
      	{if (isset($v2['title']) && !empty($v2['title']) )}{$msg=$v2['title']}{/if}
          {if $show_docs}
      	    {$v.message = "`$v.message` 
    
üìù <a href='{$url}'>{$msg}</a>"}
          {/if}
         {if $keys_docs}
	       {key l=120+$k t="üìù `$msg`" c=$url}
         {/if} 
       {/if}
     {/if}
  {/foreach}
{/if}

{* Album *}
{if $show_photoalbum || $keys_albums}
   {if !empty($attachcopy)}{$attach = $attachcopy}{/if}    
   	{if !empty($attach)}
        {foreach from=$attach item=fa}
         	{if $fa.type == 'album'}

                	{$fotoalbumurl = "https://vk.com/album`$fa['album']['owner_id']`_`$fa['album']['id']`"}
               		{$fotoalbumtitle = $fa['album']['title']}
                	{$fotoalbumdes = ""}
                    {if $show_photoalbum}
                	  {$v.message = "`$v.message`

üì∑  <a href='{$fotoalbumurl}'>–§–æ—Ç–æ–∞–ª—å–±–æ–º ''{$fotoalbumtitle}''</a>"} 
                	    {if (isset($fa['album']['description']) && !empty($fa['album']['description']) && $show_photoalbum_description)}
                          {$fotoalbumdes = $fa['album']['description']}
                	      {$v.message = "`$v.message`
{$fotoalbumdes}"}                     
                        {/if}
                    {/if}
                    {if $keys_albums}
	                   {key l=130+$k t="üì∑ `$fotoalbumtitle`" c=$fotoalbumurl}
                    {/if}
			{/if}
  
  		{/foreach}
    {/if}    
{/if}

{* Like *}
{if isset($like) && $like}
	{import c=$like}
{/if}

{* –°–°–´–õ–ö–ê –ù–ê –ê–≤—Ç–æ—Ä–∞ *}
{if $show_creator && !empty($v.original.signer_id)}
{$url="https://api.vk.com/method/users.get?user_ids={$v.original.signer_id}&fields=sex&access_token={$service_key}&lang=ru&v=5.103"}
{api url=$url method='GET' format='json' assign='user'}

{$creator_url = ""}
{if $show_creator_url}
{$creator_url = "https://vk.com/id{$user.response.0.id}"}
{/if}

{$v.message = "`$v.message`

{if $user.response.0.sex==1}üë©‚Äçüíª {else}üë®‚Äçüíª {/if} <a href='{$creator_url}'>{$user.response.0.last_name} {$user.response.0.first_name}</a>"}
{/if}

{* –°–°–´–õ–ö–ê –ù–ê –ê–≤—Ç–æ—Ä–∞ –≤ —Ä–µ–ø–æ—Å—Ç–µ*}
{if $show_creator && !empty($v.original.copy_history.0.signer_id)}
{$url="https://api.vk.com/method/users.get?user_ids={$v.original.copy_history.0.signer_id}&fields=sex&access_token={$service_key}&lang=ru&v=5.103"}
{api url=$url method='GET' format='json' assign='user'}
{$creator_url = ""}
{if $show_creator_url}
{$creator_url = "https://vk.com/id{$user.response.0.id}"}
{/if}
{$v.message = "`$v.message`

{if $user.response.0.sex==1}üë©‚Äçüíª {else}üë®‚Äçüíª {/if} <a href='{$creator_url}'>{$user.response.0.last_name} {$user.response.0.first_name}</a>"}

{/if}

{* –°–°–´–õ–ö–ê –ù–ê –ê–≤—Ç–æ—Ä–∞ –µ—Å–ª–∏ –≤—Å–µ –ø–æ—Å—Ç—è—Ç*}
{if $show_creator && $v.original.from_id != $v.original.owner_id}
{$url="https://api.vk.com/method/users.get?user_ids={$v.original.from_id}&fields=sex&access_token={$service_key}&lang=ru&v=5.103"}
{api url=$url method='GET' format='json' assign='user'}
{$creator_url = ""}
{if $show_creator_url}
{$creator_url = "https://vk.com/id{$user.response.0.id}"}
{/if}
{$v.message = "{if $user.response.0.sex==1}üë©‚Äçüíª {else}üë®‚Äçüíª {/if} <a href='{$creator_url}'>{$user.response.0.last_name} {$user.response.0.first_name}</a>

`$v.message`"}
{/if}

{* SIGN *}
{if $sign }
{$v.message = "{$v.message}
{$sign}"}
{/if}
{if $sign_up }
{$v.message = "{$sign_up}
{$v.message}"}
{/if}

{* –°–°–´–õ–ö–ê –ù–ê –ò–°–¢–û–ß–ù–ò–ö *}
{*if $src_link && !empty($v.message) && !empty($src_link)*}
{if $src_link && !empty($src_link)}
{$v.message = "`$v.message`

<a href='{$v.src_link}'>`$sign_link`</a>"}
{/if}
{if $keys_src}
	{key l=140 t=$sign_link c=$v.src_link}
{/if}

{* –ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–µ–ø–æ—Å—Ç–æ–≤ *}
{if !empty($responseid) && !empty($repost_black_id) }
{if in_array($responseid, $repost_black_id)}
{$show_poll = 0}
{$show_photo = 0}
{$show_message = 0}
{$media_post = 0}
{/if}{/if}

{*–†–∞–∑–¥–µ–ª—è—Ç—å –º–µ–¥–∏—è-–ø–æ—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∏ –∫–Ω–æ–ø–∫–∏*}
{if $show_media_keys}
  {if (!$keys_src && !$keys_links && !$keys_docs && !$keys_videos && !$keys_albums && !(isset($like) && $like)) }
     {$media_k=1}
  {else}
     {$media_k=0}
  {/if}   
{else}
   {$media_k=1}
{/if}

 {* –õ–æ–≥–∏ —Ä–µ–ø–æ—Å—Ç–æ–≤ *}
 {if $show_log_send} 
 {if !empty($sign_up)}{$loggchat = $sign_up}{else}{$loggchat = $chat_id[0]}{/if}
 {if $show_message}{$show_mes=": üï∂ "}{else}{$show_mes=": ‚úñÔ∏è "}{/if}
 {if !empty($responseid)}{$logrepost = ": ‚Ü™ "}{else}{$logrepost = ""}{/if}
 {if mb_strlen($v.message, 'utf-8')>0}{$loggms =": ‚úèÔ∏è {mb_strlen($v.message, 'utf-8')}"}{else}{$loggms =""}{/if}
 {if count($v.photo)>0}{$loggphoto =": üñº {count($v.photo)}"}{else}{$loggphoto =""}{/if}
 {if count($v.video)>0}{$loggvideo =": üéû {count($v.video)}"}{else}{$loggvideo =""}{/if}
 {$logg = "$loggchat $show_mes $logrepost $loggms $loggphoto $loggvideo" }
 {*tg_sendMessage text=$logg chat_id='xxxxxxx' disable_notification=1 disable_web_page_preview=1 assign='res_log'*}
 {import c='/log' msg=$logg}
 {/if}

  {* ==== SEND MEDIA IF count(photo) == 1 *}
  {if (count($v.photo) == 1 && $show_photo) || (count($v.photo) > 1 && $show_one_photo)}
 	 {if (mb_strlen($v.message, 'utf-8') <= 1000) && $show_message}
    	{tg_sendPhoto chat_id=$chat_id  photo=$v.photo[0]['media'] caption = $v.message disable_notification=$disable_notification  keys=1 assign='res_phototext'}
        {if $show_log_error}{if empty($res_phototext.0.result.message_id)} {import c='/log' msg="–§–æ—Ç–æ —Å —Ç–µ–∫—Å—Ç–æ–º –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: \n {$res_phototext|json}"} {/if}{/if}
     {else}
     	{tg_sendPhoto chat_id=$chat_id  photo=$v.photo[0]['media'] caption='' disable_notification=$disable_notification  keys=0 assign='res_photo'}
        {if $show_log_error}{if empty($res_photo.0.result.message_id)} {import c='/log' msg="–§–æ—Ç–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: </br> {$res_photo|json}"} {/if}{/if}
     {/if}
  {/if}
    {*$w=sleep(4)*}

  {* ==== SEND MEDIA IF count(photo)>=2 *}
  {if count($v.photo) >= 2 && $media_post && !($show_one_photo)}
      {if (mb_strlen($v.message, 'utf-8') <= 1000) && $show_message && $media_k}
        {tg_sendMediaGroup chat_id=$chat_id  media=$v.photo caption=$v.message disable_notification=$disable_notification  keys=0 assign='res_mediatext'}
        {if $show_log_error}{if empty($res_mediatext.0.result.0.message_id) && empty($res_mediatext.result.0.message_id)} {import c='/log' msg="–ú–µ–¥–∏–∞ —Å —Ç–µ–∫—Å—Ç–æ–º –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: \n {$res_mediatext|json}"} {/if}{/if}
      {else}
        {tg_sendMediaGroup chat_id=$chat_id  media=$v.photo caption='' disable_notification=$disable_notification  keys=0 assign='res_media'}
        {if $show_log_error}{if empty($res_media.0.result.0.message_id)} {import c='/log' msg="–ú–µ–¥–∏–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: \n {$res_media|json}"} {/if}{/if}
      {/if}
  {/if}

  {$w=sleep(4)}

  {if ((count($v.photo) == 0 || (count($v.photo) >= 1 && mb_strlen($v.message, 'utf-8') > 1000) || (count($v.photo) >= 2 && !($show_one_photo) && !$media_k) || !$media_post || !$show_photo) && $show_message  )}  {*|| (count($v.photo) >= 1 && !$show_photo) || (count($v.photo) >= 2 && !$media_post)*}
     {if $send_message_standart}
            {tg_sendMessage text=$v.message chat_id=$chat_id disable_web_page_preview=$disable_web_page_preview disable_notification=$disable_notification keys=1 assign='res_textall'}
            {if $show_log_error}{if empty($res_textall.0.result.message_id)} {import c='/log' msg="–¢–µ–∫—Å—Ç-all –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: \n {$res_textall|json}"} {/if}{/if}
     {else}
        {if mb_strlen($v.message, 'utf-8') < $send_message_len}
        	{tg_sendMessage text=$v.message chat_id=$chat_id disable_web_page_preview=$disable_web_page_preview disable_notification=$disable_notification keys=1 assign='res_text'}
            {if $show_log_error}{if empty($res_text.0.result.message_id)} {import c='/log' msg="–¢–µ–∫—Å—Ç3500 –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: \n {$res_text|json}"} {/if}{/if}
        {elseif mb_strlen($v.message, 'utf-8') < $send_message_len*2}
        	{tg_sendMessage text=mb_substr($v.message,0,$send_message_len) chat_id=$chat_id disable_web_page_preview=$disable_web_page_preview disable_notification=$disable_notification keys=0 assign='res_text21'}
			{tg_sendMessage text=mb_substr($v.message,$send_message_len,$send_message_len*2) chat_id=$chat_id disable_web_page_preview=$disable_web_page_preview disable_notification=$disable_notification keys=1 assign='res_text22'}
            {if $show_log_error}{if empty($res_text21.0.result.message_id)} {import c='/log' msg="–¢–µ–∫—Å—Ç7000-1 –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: \n {$res_text21|json}"} {/if} {/if} 
            {if $show_log_error}{if empty($res_text22.0.result.message_id)} {import c='/log' msg="–¢–µ–∫—Å—Ç7000-2 –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: \n {$res_text22|json}"} {/if} {/if}
        {else}
        	{tg_sendMessage text=mb_substr($v.message,0,$send_message_len) chat_id=$chat_id disable_web_page_preview=$disable_web_page_preview disable_notification=$disable_notification keys=0 assign='res_text31'}
            {if $show_log_error}{if empty($res_text31.0.result.message_id)} {import c='/log' msg="–¢–µ–∫—Å—Ç10500-1 –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: \n {$res_text31|json}"} {/if} {/if} 
			{tg_sendMessage text=mb_substr($v.message,$send_message_len,$send_message_len*2) chat_id=$chat_id disable_web_page_preview=$disable_web_page_preview disable_notification=$disable_notification keys=0 assign='res_text32'}
            {if $show_log_error}{if empty($res_text32.0.result.message_id)} {import c='/log' msg="–¢–µ–∫—Å—Ç10500-2 –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: \n {$res_text32|json}"} {/if} {/if}
        	{tg_sendMessage text=mb_substr($v.message,$send_message_len*2,$send_message_len*3) chat_id=$chat_id disable_web_page_preview=$disable_web_page_preview disable_notification=$disable_notification keys=1 assign='res_text33'} 
            {if $show_log_error}{if empty($res_text33.0.result.message_id)} {import c='/log' msg="–¢–µ–∫—Å—Ç10500-3 –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: \n {$res_text33|json}"} {/if} {/if}
        {/if}
    {/if}
  {/if}  

{* –û–¢–ü–†–ê–í–ö–ê –ê–£–î–ò–û–§–ê–ô–õ–û–í –ï–°–õ–ò –ï–°–¢–¨ *} 
  {if count($v.audio) > 0 && $show_audio}
  {foreach from=$v.audio item=a}
      {if (isset($a.url) && $a.url !== 'https://vk.com/mp3/audio_api_unavailable.mp3')}
          {tg_sendAudiofile chat_id=$chat_id audio=$a.url artist=$a.artist title=$a.title disable_notification=$disable_notification assign='res_audio'}
          {if $show_log_error}{if empty($res_audio.0.result.message_id)} {import c='/log' msg="–ú—É–∑—ã–∫–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: \n {$res_audio|json}"}{/if} {/if}
      {/if}
  {/foreach}
  {/if}
  
  {$w=sleep(2)}
  
{* –ì–û–õ–û–°–û–í–ê–ù–ò–ï *}  
  {if !empty($v.poll) && $show_poll}
    {$ans=[]}
	{foreach from=$v.poll.answers item=a}
     {if mb_strlen($a.text, 'utf-8') > 100}
       {$a.text = $a.text|truncate:100}
     {/if}  
       {$ans[]= $a.text}
    {/foreach}
     
   {if !empty($attachcopy)}
    	{$attach = $attachcopy}
   {/if}
     
     {if !empty($attach)}
    	 {foreach from=$attach item=po}
     		{if $po.type == 'poll'}
     			{$multiple = $po.poll.multiple}
    			{$anonymous = $po.poll.anonymous}
    		{/if}
         {/foreach}
     {/if}

     {if ($anonymous == 1) || !isset($group_id)}
     	  {$group_id = $chat_id}
          {$anonymous = 1}
     {/if} 
     
     {if mb_strlen($v.message, 'utf-8') > 0}
	  {tg_sendPoll question=$v.poll.question options=$ans chat_id=$group_id keys=0 is_anonymous=$anonymous allows_multiple_answers=$multiple  disable_notification=$disable_notification assign='res_pool'}
      {if $show_log_error}{if empty($res_pool.0.result.message_id)} {import c='/log' msg="–û–ø—Ä–æ—Å –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: \n {$res_pool|json}"} {/if} {/if}
    {else}
      {tg_sendPoll question=$v.poll.question options=$ans chat_id=$group_id keys=1 is_anonymous=$anonymous allows_multiple_answers=$multiple  disable_notification=$disable_notification assign='res_pool'}
      {if $show_log_error}{if empty($res_pool.0.result.message_id)} {import c='/log' msg="–û–ø—Ä–æ—Å –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: \n {$res_pool|json}"} {/if} {/if}
     {/if}
  {/if}

 {*if !empty($res_log) && isset($res_log)}{tg_editMessageText text="‚úÖ {$res_log.result.text}" message_id=$res_log.result.message_id chat_id=$res_log.result.chat.id}{/if*}

{/if}
